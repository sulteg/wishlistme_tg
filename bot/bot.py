import logging
import os
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    WebAppInfo,
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
)

# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ó–ê–î–ê–¢–¨ –ü–ê–†–ê–ú–ï–¢–†–´:
#
# 1) –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Telegram Bot Token (–ø–æ–ª—É—á–µ–Ω–Ω—ã–π –æ—Ç BotFather).
#    –ü—Ä–∏–º–µ—Ä: TOKEN = "123456789:AAHq8qXYZ..."
#
# 2) –£–∫–∞–∂–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π HTTPS-URL –≤–∞—à–µ–≥–æ MiniApp (frontend –≤–∏—à–ª–∏—Å—Ç–æ–≤),
#    –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å (LocalTunnel, Cloudflared –∏ —Ç.–¥.).
#    –°–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–µ lt --port 3000 --subdomain wishlistme,
#    –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç: https://wishlistme.loca.lt
#
# –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫, –∏–∑–º–µ–Ω–∏—Ç–µ —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ –Ω–∏–∂–µ:
# –≤–º–µ—Å—Ç–æ app.run_polling() ‚Äî app.run_webhook(‚Ä¶)
#
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "7741095391:AAFXS7k3ColIAcxKOCDHz6QCYmqFx4aznB8")
WEBAPP_URL = os.getenv("WEBAPP_URL", "https://wishlistme.loca.lt")
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    —Å –∫–Ω–æ–ø–∫–æ–π ¬´üõí –û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã¬ª, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–∞—à WebApp.
    """
    welcome_text = (
        "–ü—Ä–∏–≤–µ—Ç! üëã\n\n"
        "–≠—Ç–æ –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–∏–º–∏ –≤–∏—à–ª–∏—Å—Ç–∞–º–∏.\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´üõí –û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã¬ª, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ MiniApp\n"
        "–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ –≤–∏—à–ª–∏—Å—Ç—ã –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.\n\n"
        "–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å!"
    )

    keyboard = [
        [
            InlineKeyboardButton(
                text="üõí –û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã",
                web_app=WebAppInfo(WEBAPP_URL),
            )
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        text=welcome_text,
        reply_markup=reply_markup
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help. –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏.
    """
    help_text = (
        "–≠—Ç–æ—Ç –±–æ—Ç —Å–≤—è–∑–∞–Ω —Å –≤–∞—à–∏–º MiniApp –¥–ª—è –≤–∏—à–ª–∏—Å—Ç–æ–≤.\n\n"
        "1. –ù–∞–ø–∏—à–∏—Ç–µ /start, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã¬ª.\n"
        "2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É, –∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–∞—à MiniApp.\n"
        "3. –í —Å–∞–º–æ–º MiniApp –±—É–¥–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –≤–∏—à–ª–∏—Å—Ç—ã.\n\n"
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã."
    )
    await update.message.reply_text(help_text)


async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –ø—Ä–æ—á–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å
    –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞—Ç—å ¬´–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞¬ª. –ó–¥–µ—Å—å –º—ã –æ—Ç–≤–µ—á–∞–µ–º –æ–¥–Ω–æ—Å–ª–æ–∂–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.
    """
    await update.message.reply_text(
        "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–æ–∫–∞ –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ /start –∏ /help. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç—ã¬ª."
    )


def main() -> None:
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º polling.
    –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å run_polling() –Ω–∞ run_webhook(), –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ
    —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º.
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if TOKEN == "–í–ê–®_TELEGRAM_BOT_TOKEN_–ó–î–ï–°–¨" or not TOKEN.strip():
        logger.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TELEGRAM_BOT_TOKEN –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: WEBAPP_URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://
    if not WEBAPP_URL.startswith("https://"):
        logger.error(
            "WEBAPP_URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º HTTPS –∞–¥—Ä–µ—Å–æ–º –≤–∞—à–µ–≥–æ MiniApp, "
            "–Ω–∞–ø—Ä–∏–º–µ—Ä: https://wishlistme.loca.lt"
        )
        return

    # –°—Ç—Ä–æ–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–±–æ—Ç)
    app = ApplicationBuilder().token(TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–µ–Ω–¥–ª–µ—Ä—ã:
    # - /start ‚Üí –∫–Ω–æ–ø–∫–∞ WebApp
    app.add_handler(CommandHandler("start", start))
    # - /help ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∞
    app.add_handler(CommandHandler("help", help_command))
    # - –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç ‚Üí echo (—Å–æ–æ–±—â–∞–µ–º, —á—Ç–æ –º—ã –ø–æ–Ω–∏–º–∞–µ–º –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ /start –∏ /help)
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    # –ó–∞–ø—É—Å–∫ polling:
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (polling)...")
    app.run_polling()

    # –ï—Å–ª–∏ –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook (–Ω–∞ VPS —Å HTTPS), –∑–∞–º–µ–Ω–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –Ω–∞:
    # app.run_webhook(
    #     listen="0.0.0.0",
    #     port=int(os.getenv("PORT", "8443")),
    #     url_path=TOKEN,
    #     webhook_url=f"https://<–í–ê–®_–î–û–ú–ï–ù>/webhook/{TOKEN}"
    # )


if __name__ == "__main__":
    main()
